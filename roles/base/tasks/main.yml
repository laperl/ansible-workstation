---
# roles/base/tasks/main.yml

# 1) Carga variables de paquetes según la familia del SO
- name: "Cargar vars según familia de SO"
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_facts['os_family'] }}.yml"

# 2) APT: update caché solo en Debian/Ubuntu
- name: "Actualizar caché de paquetes"
  when: ansible_facts['os_family'] == "Debian"
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  tags: ['apt']

# 3) Instalar paquetes base
- name: "Instalar paquetes base (agnóstico cuando se pueda)"
  ansible.builtin.package:
    name: "{{ base_packages }}"
    state: present
  tags: ['apt']

# 4) Flathub remoto
- name: "Asegurar Flathub"
  community.general.flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
  tags: ['flatpak']

# 5) Detectar si 'stow' soporta --adopt
- name: "Detectar soporte de --adopt en stow"
  become: false
  ansible.builtin.command: stow --help
  register: base_stow_help
  changed_when: false
  failed_when: false
  tags: ['dotfiles']

# 6) Desplegar dotfiles con Stow
# GURU FIX: Simplificación de la lógica booleana para evitar Deprecation Warning
- name: "Desplegar dotfiles con Stow (con --adopt si está disponible)"
  become: false
  vars:
    target_home: "{{ workstation_facts_home }}"
    # Calculamos el flag directamente en una lista limpia
    stow_flags: >-
      {{
        ['--adopt'] if (base_stow_help.stdout is search('--adopt')) else []
      }}
  ansible.builtin.command:
    argv: "{{ ['stow'] + stow_flags + ['-t', target_home, item] }}"
    chdir: "{{ playbook_dir }}/dotfiles"
  loop: "{{ dotfiles_packages }}"
  register: base_stow_run
  failed_when: false
  changed_when: false
  tags: ['dotfiles']

# 7) Fallback cuando NO hay --adopt
- name: "Fallback sin --adopt: backup de conflictos y reintento"
  # GURU FIX: Uso directo de search sin filtros bool intermedios
  when: base_stow_help.stdout is not search('--adopt')
  become: false
  vars:
    target_home: "{{ workstation_facts_home }}"
  block:
    - name: "Mover a backup archivos en conflicto de cada paquete"
      ansible.builtin.shell: |
        set -euo pipefail
        pkg="{{ item }}"
        cd "{{ playbook_dir }}/dotfiles"
        TS="$(date +%Y%m%d-%H%M%S)"
        mkdir -p "{{ target_home }}/dotfiles-backup/${TS}"

        while IFS= read -r -d '' f; do
          rel="${f#${pkg}/}"
          tgt="{{ target_home }}/${rel}"
          mkdir -p "$(dirname "$tgt")"
          if [ -e "$tgt" ] && [ ! -L "$tgt" ]; then
            mv "$tgt" "{{ target_home }}/dotfiles-backup/${TS}/$(basename "$tgt").bak"
          fi
        done < <(find "$pkg" -type f -print0)
      args:
        executable: /bin/bash
      loop: "{{ dotfiles_packages }}"
      changed_when: true
      tags: ['dotfiles']

    - name: "Reintentar Stow sin conflictos"
      ansible.builtin.command:
        argv: ["stow", "-t", "{{ target_home }}", "{{ item }}"]
        chdir: "{{ playbook_dir }}/dotfiles"
      loop: "{{ dotfiles_packages }}"
      changed_when: false
      tags: ['dotfiles']

# 7.b) Caso especial de htop
- name: "Soft htop: caso especial (copy, not stow)"
  ansible.builtin.import_tasks: htop.yml
  tags: ['dotfiles', 'htop']

# 8) Verificación de SOPS
- name: "Verificar presencia de SOPS"
  ansible.builtin.command: sops --version
  register: base_sops_check
  changed_when: false
  tags: ['sops']
