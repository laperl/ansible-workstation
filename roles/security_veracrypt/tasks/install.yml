---
- name: "Gestión Segura de VeraCrypt"
  become: true
  block:
    - name: "Asegurar dependencias del sistema"
      ansible.builtin.apt:
        name: "{{ veracrypt_dep_packages }}"
        state: present
        update_cache: true

    - name: "Crear directorio temporal para GPG (Permisos 0700)"
      ansible.builtin.tempfile:
        state: directory
        suffix: .vc_gpg
      register: _tmp_gpg_dir

    - name: "Cambiar permisos del directorio temporal"
      ansible.builtin.file:
        path: "{{ _tmp_gpg_dir.path }}"
        mode: '0700'
        owner: root

    - name: "Descargar Clave PGP, Paquete y Firma"
      ansible.builtin.get_url:
        url: "{{ item.url }}"
        dest: "{{ item.dest }}"
        mode: '0644'
      loop:
        - {url: "{{ veracrypt_pgp_key_url }}", dest: "{{ _tmp_gpg_dir.path }}/pubkey.asc"}
        - {url: "{{ veracrypt_deb_url }}", dest: "{{ _tmp_gpg_dir.path }}/veracrypt.{{ veracrypt_pkg_ext }}"}
        - {url: "{{ veracrypt_sig_url }}", dest: "{{ _tmp_gpg_dir.path }}/veracrypt.{{ veracrypt_pkg_ext }}.sig"}

    - name: "Importar clave y verificar firma PGP"
      ansible.builtin.shell: |
        set -o pipefail
        gpg --no-default-keyring --keyring {{ _tmp_gpg_dir.path }}/check.gpg --import {{ _tmp_gpg_dir.path }}/pubkey.asc
        gpg --no-default-keyring --keyring {{ _tmp_gpg_dir.path }}/check.gpg --verify {{ _tmp_gpg_dir.path }}/veracrypt.{{ veracrypt_pkg_ext }}.sig {{ _tmp_gpg_dir.path }}/veracrypt.{{ veracrypt_pkg_ext }}
      args:
        executable: /bin/bash
      changed_when: false

    - name: "Instalar paquete verificado"
      ansible.builtin.apt:
        deb: "{{ _tmp_gpg_dir.path }}/veracrypt.{{ veracrypt_pkg_ext }}"

  always:
    - name: "Limpieza profunda: Eliminar keyring y binarios temporales"
      ansible.builtin.file:
        path: "{{ _tmp_gpg_dir.path }}"
        state: absent
      when: _tmp_gpg_dir.path is defined

- name: "Verificación Post-Instalación"
  ansible.builtin.command: veracrypt -t --version
  register: _vc_check
  changed_when: false
  failed_when: veracrypt_version not in _vc_check.stdout
